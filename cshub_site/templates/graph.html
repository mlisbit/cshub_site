{% extends "base.html" %}
{% load staticfiles %}
{% load tags %}



{% block content %}

<script src="{% static "sigma/sigma.min.js" %}"></script>
<script src="{% static "sigma/plugins/sigma.plugins.animate.min.js" %}"></script>
<div id="container">
  <style>
    #graph-container {
      margin-top: 10px;
      width:100%;
      height: 400px;
    }
  </style>
  <div id="graph-container"></div>
</div>
{% endblock %}

{% block endscripts %}
  <script type="text/javascript">

    var user_graph = {nodes: [],edges: []}
    var temp_node = {}
    var temp_edge = {}
    var step = 0
    var lines = 5

    var received_data = {% autoescape off %}{{ json_time }}{% endautoescape %};
    //console.log(received_data);

    function add_users(data) {
      $.each(data, function(i, value) {
        temp_node = {
          id: 'n_' + i,
          label: value.fields.user.fields.username,
          x: Math.cos(Math.PI * 2 * i / data.length - Math.PI / 2),
          y: Math.sin(Math.PI * 2 * i / data.length - Math.PI / 2),
          color: '#ccc',
          size: 1
        }

        var keys = ['x', 'y'];
        keys.forEach(function(val) {
          temp_node['pos_1_'+val] = temp_node[val];
          temp_node['pos_2_'+val] = temp_node[val];
        });

        user_graph.nodes.push(temp_node);
      });
    } //end add_users

    function add_social() {
      var social_test_nodes = {
        'github': {
          label: 'github',
          pos_1_x: -2,
          pos_1_y: -0,
          pos_2_x: -2.1,
          pos_2_y: -0.2,
          x: -2,
          y: 0
        },
        'facebook': {
          label: 'facebook',
          pos_1_x: 2,
          pos_1_y: 0,
          pos_2_x: 2.1,
          pos_2_y: 0.1,
          x: 2,
          y: 0
        },
        'twitter': {
          label: 'twitter',
          pos_1_x: -1.9,
          pos_1_y: -0.5,
          pos_2_x: -2.1,
          pos_2_y: -1,
          x: -1.9,
          y: -0.5
        },
        'linkedin': {
          label: 'linkedin',
          pos_1_x: 1.8,
          pos_1_y: 1,
          pos_2_x: 2,
          pos_2_y: 0.8,
          x: 1.8,
          y: 1
        }
      }

      $.each(social_test_nodes, function(i, val) {
        temp_node = {
          id: 'sn_' + i,
          label: val.label,
          x: val.x,
          y: val.y,
          pos_1_x: val.pos_1_x,
          pos_1_y: val.pos_1_y,
          pos_2_x: val.pos_2_x,
          pos_2_y: val.pos_2_y,
          color: '#000',
          size: 1.5
        }
        user_graph.nodes.push(temp_node);
      });
    }

    function add_edges() {
      $.each(received_data, function(i, value) {
        if (value.fields.github_link) {
          temp_edge = {
            id: 'e_g_' + i,
            source: 'n_' + i,
            target: 'sn_github'
          }
          user_graph.edges.push(temp_edge);
        }      
        if (value.fields.facebook_link) {
          temp_edge = {
            id: 'e_f_' + i,
            source: 'n_' + i,
            target: 'sn_facebook'
          }
          user_graph.edges.push(temp_edge);
        }      
        if (value.fields.linkedin_link) {
          temp_edge = {
            id: 'e_l_' + i,
            source: 'n_' + i,
            target: 'sn_linkedin'
          }
          user_graph.edges.push(temp_edge);
        }      
        if (value.fields.twitter_link) {
          temp_edge = {
            id: 'e_t_' + i,
            source: 'n_' + i,
            target: 'sn_twitter'
          }
          user_graph.edges.push(temp_edge);
        }      
      });
    }

    add_users(received_data)
    add_social()
    add_edges()
    console.log(received_data)
    s = new sigma({
      graph: user_graph,
      container: 'graph-container',
      settings: {
        animationsTime: 1000,
        enableCamera: false,
        labelThreshold: 1000,
      }
    });

    
    setInterval(function() {
      var prefix = ['pos_1_', 'pos_2_'][step = +!step];
      sigma.plugins.animate(
        s,
        {
          x: prefix+'x',
          y: prefix+'y'
        }
      );
    }, 2000);

    console.log(user_graph)
  </script>
{% endblock %}